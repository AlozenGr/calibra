<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calibração – Estação Total (Web)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-4 md:p-8 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Calibração – Estação Total</h1>
      <span class="text-xs text-slate-500" id="status">offline</span>
    </header>

    <!-- 1) Nova calibração -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-3">1) Nova calibração</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
        <input id="calibId" class="border rounded p-2" placeholder="ID (ex: CAL-2025-001)" />
        <input id="data" type="date" class="border rounded p-2" />
        <input id="cliente" class="border rounded p-2 col-span-2" placeholder="Cliente / Razão Social" />
        <input id="cnpj" class="border rounded p-2" placeholder="CNPJ/CPF" />
        <input id="instrumento" class="border rounded p-2" placeholder="Instrumento (Estação Total)" />
        <input id="fabricante" class="border rounded p-2" placeholder="Fabricante" />
        <input id="modelo" class="border rounded p-2" placeholder="Modelo" />
        <input id="ns" class="border rounded p-2" placeholder="Nº de Série" />
        <input id="res" class="border rounded p-2" placeholder='Resolução angular (")' />
        <input id="obs" class="border rounded p-2 col-span-2" placeholder="Observações" />
      </div>
      <div class="mt-3 flex gap-2">
        <button class="px-3 py-2 rounded bg-blue-600 text-white" onclick="novaCalibracao()">Salvar</button>
      </div>
    </section>

    <!-- 2) Leituras EDM -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-3">2) Leituras EDM (distância)</h2>
      <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm">
        <input id="edm_calibId" class="border rounded p-2" placeholder="calibId" />
        <input id="edm_ponto" class="border rounded p-2" placeholder="Ponto" />
        <input id="edm_rep" class="border rounded p-2" placeholder="Repetição" />
        <input id="edm_dn" class="border rounded p-2" placeholder="Dist. nominal (m)" />
        <input id="edm_dl" class="border rounded p-2" placeholder="Dist. lida (m)" />
        <input id="edm_face" class="border rounded p-2" placeholder="Face" />
        <input id="edm_t" class="border rounded p-2" placeholder="Temperatura (°C)" />
        <input id="edm_ur" class="border rounded p-2" placeholder="UR (%)" />
        <input id="edm_p" class="border rounded p-2" placeholder="Pressão (hPa)" />
        <input id="edm_obs" class="border rounded p-2 col-span-2 md:col-span-4" placeholder="Observações" />
        <label class="flex items-center gap-2"><input id="edm_usar" type="checkbox" checked /> usar?</label>
      </div>
      <div class="mt-3 flex gap-2">
        <button class="px-3 py-2 rounded bg-emerald-600 text-white" onclick="addEdm()">Adicionar</button>
      </div>
    </section>

    <!-- 3) Leituras Ângulos -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-3">3) Leituras Ângulos (HZ / V)</h2>
      <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm">
        <input id="ang_calibId" class="border rounded p-2" placeholder="calibId" />
        <select id="ang_tipo" class="border rounded p-2">
          <option value="HZ">Horizontal (HZ)</option>
          <option value="V">Vertical (V)</option>
        </select>
        <input id="ang_conj" class="border rounded p-2" placeholder="Conjunto" />
        <input id="ang_alvo" class="border rounded p-2" placeholder="Alvo" />
        <input id="ang_nom" class="border rounded p-2" placeholder="Ângulo nominal (°)" />
        <input id="ang_f1" class="border rounded p-2" placeholder="F1 (°)" />
        <input id="ang_f2" class="border rounded p-2" placeholder="F2 (°)" />
        <input id="ang_obs" class="border rounded p-2 col-span-2 md:col-span-4" placeholder="Observações" />
        <label class="flex items-center gap-2"><input id="ang_usar" type="checkbox" checked /> usar?</label>
      </div>
      <div class="mt-3 flex gap-2">
        <button class="px-3 py-2 rounded bg-emerald-600 text-white" onclick="addAng()">Adicionar</button>
      </div>
    </section>

    <!-- 4) Processar e Relatar -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-3">4) Processar e Relatar</h2>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <input id="run_calibId" class="border rounded p-2 col-span-2" placeholder="calibId" />
      </div>
      <div class="mt-3 flex gap-2 flex-wrap">
        <button class="px-3 py-2 rounded bg-violet-600 text-white" onclick="calcular()">Calcular resultados</button>
        <button class="px-3 py-2 rounded bg-slate-700 text-white" onclick="relatorio()">Gerar relatório</button>
        <button class="px-3 py-2 rounded bg-amber-600 text-white" onclick="carregar()">Carregar estado</button>
      </div>

      <div id="out" class="text-xs text-slate-600 mt-3 whitespace-pre-wrap"></div>

      <div id="pane_results" class="hidden mt-3 border rounded-lg p-3">
        <div class="font-semibold mb-2">Resultados calculados</div>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div><b>d₀ (mm)</b>: <span id="r_d0"></span></div>
          <div><b>k (ppm)</b>: <span id="r_k"></span></div>
          <div><b>U(d₀) (mm)</b>: <span id="r_Ud0"></span></div>
          <div><b>U(k) (ppm)</b>: <span id="r_Uk"></span></div>
          <div><b>C (")</b>: <span id="r_C"></span></div>
          <div><b>i (")</b>: <span id="r_i"></span></div>
          <div><b># EDM</b>: <span id="r_edmN"></span></div>
          <div><b># Ângulos</b>: <span id="r_angN"></span></div>
        </div>
      </div>

      <div id="pane_links" class="hidden mt-3 border rounded-lg p-3 text-sm">
        <div class="font-semibold mb-2">Relatório</div>
        <div>Documento: <a id="link_doc" class="text-blue-700 underline" target="_blank" rel="noopener">abrir</a></div>
        <div>PDF: <a id="link_pdf" class="text-blue-700 underline" target="_blank" rel="noopener">baixar</a></div>
      </div>
    </section>
  </div>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbwuJwBdEiN8rk3LgwOsWHoovbTqiI9aUfpUOMwTfJsu9JYazNCxdQiZgDtS8vibDKym/exec';

    // Envia como x-www-form-urlencoded (sem preflight CORS)
    async function callAPI(action, payload) {
      const body = new URLSearchParams({ data: JSON.stringify({ action, payload }) });
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });
      try { return await res.json(); } catch(e) { return { ok:false, error:'Resposta inválida do servidor.' }; }
    }

    function show(el){ el.classList.remove('hidden'); }
    function val(id){ return document.getElementById(id).value; }
    function chk(id){ return document.getElementById(id).checked; }

    (async () => {
      try {
        const res = await fetch(API_BASE + '?ping=1');
        if (res.ok) document.getElementById('status').innerText = 'online';
      } catch(e){}
    })();

    async function novaCalibracao(){
      const form = {
        calibId: val('calibId'), data: val('data'), cliente: val('cliente'), cnpj: val('cnpj'),
        instrumento: val('instrumento') || 'Estação Total', fabricante: val('fabricante'),
        modelo: val('modelo'), ns: val('ns'), res_ang_arcsec: val('res'), obs: val('obs')
      };
      const r = await callAPI('newCalibration', form);
      document.getElementById('out').innerText = JSON.stringify(r, null, 2);
    }

    async function addEdm(){
      const row = {
        calibId: val('edm_calibId'), ponto: val('edm_ponto'), rep: val('edm_rep'),
        dist_nom_m: val('edm_dn'), dist_lida_m: val('edm_dl'), face: val('edm_face'),
        temp_C: val('edm_t'), UR_percent: val('edm_ur'), press_hPa: val('edm_p'),
        obs: val('edm_obs'), usar: chk('edm_usar')
      };
      const r = await callAPI('addEdmRows', [row]);
      document.getElementById('out').innerText = JSON.stringify(r, null, 2);
    }

    async function addAng(){
      const row = {
        calibId: val('ang_calibId'), conjunto: val('ang_conj'), alvo: val('ang_alvo'),
        ang_nom_deg: val('ang_nom'), F1_deg: val('ang_f1'), F2_deg: val('ang_f2'),
        obs: val('ang_obs'), usar: chk('ang_usar')
      };
      const tipo = document.getElementById('ang_tipo').value;
      const r = await callAPI('addAngleRows', { rows:[row], tipo });
      document.getElementById('out').innerText = JSON.stringify(r, null, 2);
    }

    async function calcular(){
      const id = val('run_calibId');
      const r = await callAPI('computeAll', { calibId: id });
      document.getElementById('out').innerText = JSON.stringify(r, null, 2);
      if (r && r.ok){
        document.getElementById('r_d0').innerText = r.d0_mm ?? '';
        document.getElementById('r_k').innerText = r.k_ppm ?? '';
        document.getElementById('r_C').innerText = r.C_arcsec ?? '';
        document.getElementById('r_i').innerText = r.i_arcsec ?? '';
        document.getElementById('r_edmN').innerText = r.edmN ?? '';
        document.getElementById('r_angN').innerText = r.angN ?? '';
        show(document.getElementById('pane_results'));
      }
    }

    async function relatorio(){
      const id = val('run_calibId');
      const r = await callAPI('generateReport', { calibId: id });
      document.getElementById('out').innerText = JSON.stringify(r, null, 2);
      if (r && r.ok){
        const a1 = document.getElementById('link_doc');
        const a2 = document.getElementById('link_pdf');
        if (r.docUrl) a1.href = r.docUrl;
        if (r.pdfUrl) a2.href = r.pdfUrl;
        show(document.getElementById('pane_links'));
      }
    }

    async function carregar(){
      const id = val('run_calibId');
      const r = await callAPI('getState', { calibId: id });
      document.getElementById('out').innerText = JSON.stringify(r, null, 2);
      if (r && r.ok && r.data){
        const st = r.data;
        if (st.results){
          document.getElementById('r_d0').innerText = st.results.d0_mm ?? '';
          document.getElementById('r_k').innerText = st.results.k_ppm ?? '';
          document.getElementById('r_Ud0').innerText = st.results.U_d0_mm ?? '';
          document.getElementById('r_Uk').innerText = st.results.U_k_ppm ?? '';
          document.getElementById('r_C').innerText = st.results.C_arcsec ?? '';
          document.getElementById('r_i').innerText = st.results.i_arcsec ?? '';
          document.getElementById('r_edmN').innerText = (st.edm || []).length;
          document.getElementById('r_angN').innerText = (st.hz || []).length + (st.v || []).length;
          show(document.getElementById('pane_results'));
        }
        if (st.rel){
          const a1 = document.getElementById('link_doc');
          const a2 = document.getElementById('link_pdf');
          if (st.rel.doc_url) a1.href = st.rel.doc_url;
          if (st.rel.pdf_url) a2.href = st.rel.pdf_url;
          show(document.getElementById('pane_links'));
        }
      }
    }
  </script>
</body>
</html>
