<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calibração – Estação Total</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-4 md:p-8 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Calibração – Estação Total</h1>
      <span id="status" class="text-xs text-slate-500">offline</span>
    </header>

    <!-- 1) Nova Calibração -->
    <section class="bg-white shadow rounded-2xl p-4">
      <h2 class="font-semibold mb-3">1) Nova Calibração</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
        <input id="calibId" class="border p-2 rounded" placeholder="ID (ex: CAL-001)" />
        <input id="data" type="date" class="border p-2 rounded" />
        <input id="cliente" class="border p-2 rounded col-span-2" placeholder="Cliente" />
        <input id="cnpj" class="border p-2 rounded" placeholder="CNPJ/CPF" />
        <input id="instrumento" class="border p-2 rounded" placeholder="Instrumento" />
        <input id="fabricante" class="border p-2 rounded" placeholder="Fabricante" />
        <input id="modelo" class="border p-2 rounded" placeholder="Modelo" />
        <input id="ns" class="border p-2 rounded" placeholder="Nº SÉRIE" />
        <input id="res" class="border p-2 rounded" placeholder='Resolução angular (")' />
        <input id="obs" class="border p-2 rounded col-span-2" placeholder="Observações" />
      </div>
      <button onclick="novaCalibracao()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded">
        Salvar
      </button>
    </section>

    <!-- 2) EDM -->
    <section class="bg-white shadow rounded-2xl p-4">
      <h2 class="font-semibold mb-3">2) Leituras EDM</h2>
      <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm">
        <input id="edm_calibId" class="border p-2 rounded" placeholder="calibId" />
        <input id="edm_ponto" class="border p-2 rounded" placeholder="Ponto" />
        <input id="edm_rep" class="border p-2 rounded" placeholder="Repetição" />
        <input id="edm_dn" class="border p-2 rounded" placeholder="Dist. nominal (m)" />
        <input id="edm_dl" class="border p-2 rounded" placeholder="Dist. lida (m)" />
        <input id="edm_face" class="border p-2 rounded" placeholder="Face" />
        <input id="edm_t" class="border p-2 rounded" placeholder="Temperatura (°C)" />
        <input id="edm_ur" class="border p-2 rounded" placeholder="UR (%)" />
        <input id="edm_p" class="border p-2 rounded" placeholder="Pressão (hPa)" />
        <input id="edm_obs" class="border p-2 rounded col-span-2 md:col-span-4" placeholder="Observações" />
        <label class="flex gap-2 items-center">
          <input id="edm_usar" type="checkbox" checked /> usar
        </label>
      </div>
      <button onclick="addEdm()" class="mt-3 bg-emerald-600 text-white px-4 py-2 rounded">
        Adicionar
      </button>
    </section>

    <!-- 3) Ângulos -->
    <section class="bg-white shadow rounded-2xl p-4">
      <h2 class="font-semibold mb-3">3) Leituras Angulares</h2>
      <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm">
        <input id="ang_calibId" class="border p-2 rounded" placeholder="calibId" />
        <select id="ang_tipo" class="border p-2 rounded">
          <option value="HZ">Horizontal</option>
          <option value="V">Vertical</option>
        </select>
        <input id="ang_conj" class="border p-2 rounded" placeholder="Conjunto" />
        <input id="ang_alvo" class="border p-2 rounded" placeholder="Alvo" />
        <input id="ang_nom" class="border p-2 rounded" placeholder="Ângulo nominal (°)" />
        <input id="ang_f1" class="border p-2 rounded" placeholder="F1 (°)" />
        <input id="ang_f2" class="border p-2 rounded" placeholder="F2 (°)" />
        <input id="ang_obs" class="border p-2 rounded col-span-2 md:col-span-4" placeholder="Observações" />
        <label class="flex gap-2 items-center">
          <input id="ang_usar" type="checkbox" checked /> usar
        </label>
      </div>
      <button onclick="addAng()" class="mt-3 bg-emerald-600 text-white px-4 py-2 rounded">
        Adicionar
      </button>
    </section>

    <!-- 4) Processar -->
    <section class="bg-white shadow rounded-2xl p-4">
      <h2 class="font-semibold mb-3">4) Processar</h2>

      <!-- Etapa ANTES / DEPOIS -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm mb-2">
        <input id="run_calibId" class="border p-2 rounded" placeholder="calibId" />
        <select id="fase" class="border p-2 rounded">
          <option value="ANTES">Situação atual (ANTES da calibração)</option>
          <option value="DEPOIS">Após calibração (DEPOIS da intervenção)</option>
        </select>
      </div>

      <div class="mt-3 flex gap-2 flex-wrap">
        <button onclick="calcular()" class="bg-violet-600 text-white px-3 py-2 rounded">
          Calcular
        </button>
        <button onclick="relatorio()" class="bg-slate-700 text-white px-3 py-2 rounded">
          Gerar Relatório
        </button>
        <button onclick="carregar()" class="bg-amber-600 text-white px-3 py-2 rounded">
          Carregar
        </button>
      </div>

      <pre id="out" class="mt-3 text-xs whitespace-pre-wrap text-slate-600"></pre>

      <!-- Resultados ANTES / DEPOIS -->
      <div id="pane_results" class="hidden mt-4 border rounded p-3 text-sm space-y-3">
        <h3 class="font-semibold mb-2">Resultados da calibração</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- ANTES -->
          <div>
            <div class="font-semibold mb-1">Situação atual (ANTES)</div>
            <div class="text-xs text-slate-500 mb-1">
              Estado do equipamento antes da intervenção
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>d₀ (mm): <span id="r_d0_antes"></span></div>
              <div>k (ppm): <span id="r_k_antes"></span></div>
              <div>C ("): <span id="r_C_antes"></span></div>
              <div>i ("): <span id="r_i_antes"></span></div>
            </div>
          </div>

          <!-- DEPOIS -->
          <div>
            <div class="font-semibold mb-1">Após calibração (DEPOIS)</div>
            <div class="text-xs text-slate-500 mb-1">
              Estado do equipamento após ajustes/aferição
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>d₀ (mm): <span id="r_d0_depois"></span></div>
              <div>k (ppm): <span id="r_k_depois"></span></div>
              <div>C ("): <span id="r_C_depois"></span></div>
              <div>i ("): <span id="r_i_depois"></span></div>
            </div>
          </div>
        </div>
      </div>

      <div id="pane_links" class="hidden mt-4 border rounded p-3 text-sm">
        <h3 class="font-semibold mb-2">Relatório</h3>
        <div>Doc: <a id="link_doc" target="_blank" class="text-blue-600 underline">abrir</a></div>
        <div>PDF: <a id="link_pdf" target="_blank" class="text-blue-600 underline">baixar</a></div>
      </div>
    </section>

  </div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbxtNjTBLnBKwFizYNfe_X_ChdKzu8R6Jn9fOwJgvHrI0nPcMMHg_EsqUEx2wccFuY2s/exec";

function v(id){ return document.getElementById(id).value; }
function c(id){ return document.getElementById(id).checked; }
function show(el){ el.classList.remove("hidden"); }

const outEl = document.getElementById("out");

async function callAPI(action, payload = {}) {
  const body = new URLSearchParams({ data: JSON.stringify({ action, payload }) });
  const res = await fetch(API_BASE, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body
  });
  try {
    return await res.json();
  } catch (e) {
    return { ok: false, error: "Resposta inválida do servidor" };
  }
}

// ping inicial
(async () => {
  try {
    const r = await fetch(API_BASE + "?ping=1");
    if (r.ok) document.getElementById("status").innerText = "online";
  } catch (e) {}
})();

// 1) Nova calibração
async function novaCalibracao() {
  const r = await callAPI("newCalibration", {
    calibId: v("calibId"),
    data: v("data"),
    cliente: v("cliente"),
    cnpj: v("cnpj"),
    instrumento: v("instrumento"),
    fabricante: v("fabricante"),
    modelo: v("modelo"),
    ns: v("ns"),
    res_ang_arcsec: v("res"),
    obs: v("obs")
  });
  outEl.innerText = JSON.stringify(r, null, 2);
}

// 2) EDM
async function addEdm() {
  const r = await callAPI("addEdmRows", [{
    calibId: v("edm_calibId"),
    ponto: v("edm_ponto"),
    rep: v("edm_rep"),
    dist_nom_m: v("edm_dn"),
    dist_lida_m: v("edm_dl"),
    face: v("edm_face"),
    temp_C: v("edm_t"),
    UR_percent: v("edm_ur"),
    press_hPa: v("edm_p"),
    obs: v("edm_obs"),
    usar: c("edm_usar")
  }]);
  outEl.innerText = JSON.stringify(r, null, 2);
}

// 3) Ângulos
async function addAng() {
  const r = await callAPI("addAngleRows", {
    rows: [{
      calibId: v("ang_calibId"),
      conjunto: v("ang_conj"),
      alvo: v("ang_alvo"),
      ang_nom_deg: v("ang_nom"),
      F1_deg: v("ang_f1"),
      F2_deg: v("ang_f2"),
      obs: v("ang_obs"),
      usar: c("ang_usar")
    }],
    tipo: document.getElementById("ang_tipo").value
  });
  outEl.innerText = JSON.stringify(r, null, 2);
}

// 4) Calcular
async function calcular() {
  const r = await callAPI("computeAll", {
    calibId: v("run_calibId"),
    fase: v("fase")   // ANTES ou DEPOIS
  });
  outEl.innerText = JSON.stringify(r, null, 2);
  if (r && r.ok) {
    await carregar(); // carrega estado completo, incluindo ANTES/DEPOIS
  }
}

// 5) Gerar relatório
async function relatorio() {
  const r = await callAPI("generateReport", {
    calibId: v("run_calibId")
  });
  outEl.innerText = JSON.stringify(r, null, 2);
  if (r && r.ok) {
    const a1 = document.getElementById("link_doc");
    const a2 = document.getElementById("link_pdf");
    if (r.docUrl) a1.href = r.docUrl;
    if (r.pdfUrl) a2.href = r.pdfUrl;
    show(document.getElementById("pane_links"));
  }
}

// 6) Carregar estado (preenche ANTES/DEPOIS)
async function carregar() {
  const r = await callAPI("getState", {
    calibId: v("run_calibId")
  });
  outEl.innerText = JSON.stringify(r, null, 2);

  if (r && r.ok && r.data) {
    const st = r.data;
    const resAntes  = st.results && st.results.antes  ? st.results.antes  : null;
    const resDepois = st.results && st.results.depois ? st.results.depois : null;

    document.getElementById("r_d0_antes").innerText   = resAntes  ? resAntes.d0_mm    : "";
    document.getElementById("r_k_antes").innerText    = resAntes  ? resAntes.k_ppm    : "";
    document.getElementById("r_C_antes").innerText    = resAntes  ? resAntes.C_arcsec : "";
    document.getElementById("r_i_antes").innerText    = resAntes  ? resAntes.i_arcsec : "";

    document.getElementById("r_d0_depois").innerText  = resDepois ? resDepois.d0_mm   : "";
    document.getElementById("r_k_depois").innerText   = resDepois ? resDepois.k_ppm   : "";
    document.getElementById("r_C_depois").innerText   = resDepois ? resDepois.C_arcsec: "";
    document.getElementById("r_i_depois").innerText   = resDepois ? resDepois.i_arcsec: "";

    show(document.getElementById("pane_results"));

    if (st.rel && st.rel.doc_url) {
      document.getElementById("link_doc").href = st.rel.doc_url;
      if (st.rel.pdf_url) document.getElementById("link_pdf").href = st.rel.pdf_url;
      show(document.getElementById("pane_links"));
    }
  }
}
</script>

</body>
</html>
