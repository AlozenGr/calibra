<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Calibração – Estação Total</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">

<div class="max-w-5xl mx-auto p-4 space-y-6">

<h1 class="text-xl font-bold">Calibração – Estação Total</h1>
<div id="status" class="text-sm text-gray-500">offline</div>

<!-- Nova Calibração -->
<section class="bg-white p-4 rounded-xl shadow">
<h2 class="font-semibold mb-3">1) Nova Calibração</h2>

<div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
<input id="calibId" class="border p-2 rounded" placeholder="ID">
<input id="data" type="date" class="border p-2 rounded">
<input id="cliente" class="border p-2 rounded col-span-2" placeholder="Cliente">
<input id="cnpj" class="border p-2 rounded" placeholder="CNPJ">
<input id="instrumento" class="border p-2 rounded" placeholder="Instrumento">
<input id="fabricante" class="border p-2 rounded" placeholder="Fabricante">
<input id="modelo" class="border p-2 rounded" placeholder="Modelo">
<input id="ns" class="border p-2 rounded" placeholder="Nº Série">
<input id="res" class="border p-2 rounded" placeholder='Resolução (")'>
<input id="obs" class="border p-2 rounded col-span-2" placeholder="Observações">
</div>

<button onclick="novaCalibracao()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded">Salvar</button>
</section>

<!-- EDM -->
<section class="bg-white p-4 rounded-xl shadow">
<h2 class="font-semibold mb-3">2) Leituras EDM</h2>

<div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm">
<input id="edm_calibId" class="border p-2 rounded" placeholder="calibId">
<input id="edm_ponto" class="border p-2 rounded" placeholder="Ponto">
<input id="edm_dn" class="border p-2 rounded" placeholder="Dist Nom (m)">
<input id="edm_dl" class="border p-2 rounded" placeholder="Dist Lida (m)">
<input id="edm_face" class="border p-2 rounded" placeholder="Face">
<input id="edm_rep" class="border p-2 rounded" placeholder="Repetição">
<input id="edm_t" class="border p-2 rounded" placeholder="Temp (°C)">
<input id="edm_ur" class="border p-2 rounded" placeholder="UR (%)">
<input id="edm_p" class="border p-2 rounded" placeholder="Pressão (hPa)">
<input id="edm_obs" class="border p-2 rounded col-span-2" placeholder="Observações">
<label class="flex items-center gap-2"><input type="checkbox" id="edm_usar" checked> usar?</label>
</div>

<button onclick="addEdm()" class="mt-3 px-4 py-2 bg-emerald-600 text-white rounded">Adicionar</button>
</section>

<!-- Ângulos -->
<section class="bg-white p-4 rounded-xl shadow">
<h2 class="font-semibold mb-3">3) Leituras Angulares</h2>

<div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm">
<input id="ang_calibId" class="border p-2 rounded" placeholder="calibId">
<select id="ang_tipo" class="border p-2 rounded">
<option value="HZ">Horizontal</option>
<option value="V">Vertical</option>
</select>

<input id="ang_conj" class="border p-2 rounded" placeholder="Conjunto">
<input id="ang_alvo" class="border p-2 rounded" placeholder="Alvo">
<input id="ang_nom" class="border p-2 rounded" placeholder="Âng Nom (°)">
<input id="ang_f1" class="border p-2 rounded" placeholder="F1 (°)">
<input id="ang_f2" class="border p-2 rounded" placeholder="F2 (°)">
<input id="ang_obs" class="border p-2 rounded col-span-2" placeholder="Observações">
<label class="flex items-center gap-2"><input type="checkbox" id="ang_usar" checked> usar?</label>
</div>

<button onclick="addAng()" class="mt-3 px-4 py-2 bg-emerald-600 text-white rounded">Adicionar</button>
</section>

<!-- Processamento -->
<section class="bg-white p-4 rounded-xl shadow">
<h2 class="font-semibold mb-3">4) Processar</h2>

<input id="run_calibId" class="border p-2 rounded w-full" placeholder="calibId">

<div class="mt-3 flex flex-wrap gap-2">
<button onclick="calcAntes()" class="px-4 py-2 rounded bg-indigo-600 text-white">Calcular ANTES</button>
<button onclick="calcDepois()" class="px-4 py-2 rounded bg-purple-600 text-white">Calcular DEPOIS</button>
<button onclick="gerarRel()" class="px-4 py-2 rounded bg-slate-700 text-white">Gerar Relatório</button>
<button onclick="carregar()" class="px-4 py-2 rounded bg-amber-600 text-white">Carregar Dados</button>
</div>

<pre id="out" class="text-xs text-gray-600 mt-3"></pre>

</section>

</div>

<script>
const API = "SUA_URL_DO_WEBAPP_AQUI"; // SUBSTITUIR !!!

async function callAPI(action,payload){
  const body = new URLSearchParams({data:JSON.stringify({action,payload})});
  const res = await fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body
  });
  try { return await res.json(); } catch(e){ return {ok:false,error:"Erro decode"}; }
}

function val(id){ return document.getElementById(id).value; }
function chk(id){ return document.getElementById(id).checked; }

/* Nova calibração */
async function novaCalibracao(){
  const p = {
    calibId:val('calibId'),data:val('data'),cliente:val('cliente'),cnpj:val('cnpj'),
    instrumento:val('instrumento'),fabricante:val('fabricante'),modelo:val('modelo'),
    ns:val('ns'),res_ang_arcsec:val('res'),obs:val('obs')
  };
  const r = await callAPI("newCalibration",p);
  out.innerText = JSON.stringify(r,null,2);
}

/* EDM */
async function addEdm(){
  const row = {
    calibId:val('edm_calibId'),ponto:val('edm_ponto'),dist_nom_m:val('edm_dn'),
    dist_lida_m:val('edm_dl'),face:val('edm_face'),rep:val('edm_rep'),
    temp_C:val('edm_t'),UR_percent:val('edm_ur'),press_hPa:val('edm_p'),
    obs:val('edm_obs'),usar:chk('edm_usar')
  };
  const r = await callAPI("addEdmRows",[row]);
  out.innerText = JSON.stringify(r,null,2);
}

/* Ângulos */
async function addAng(){
  const row = {
    calibId:val('ang_calibId'),conjunto:val('ang_conj'),alvo:val('ang_alvo'),
    ang_nom_deg:val('ang_nom'),F1_deg:val('ang_f1'),F2_deg:val('ang_f2'),
    obs:val('ang_obs'),usar:chk('ang_usar')
  };
  const tipo = document.getElementById('ang_tipo').value;
  const r = await callAPI("addAngleRows",{rows:[row],tipo});
  out.innerText = JSON.stringify(r,null,2);
}

/* Processar */
async function calcAntes(){
  const r = await callAPI("computeAll",{calibId:val('run_calibId'),fase:"ANTES"});
  out.innerText = JSON.stringify(r,null,2);
}

async function calcDepois(){
  const r = await callAPI("computeAll",{calibId:val('run_calibId'),fase:"DEPOIS"});
  out.innerText = JSON.stringify(r,null,2);
}

async function gerarRel(){
  const r = await callAPI("generateReport",{calibId:val('run_calibId')});
  out.innerText = JSON.stringify(r,null,2);
}

async function carregar(){
  const r = await callAPI("getState",{calibId:val('run_calibId')});
  out.innerText = JSON.stringify(r,null,2);
}

</script>

</body>
</html>
